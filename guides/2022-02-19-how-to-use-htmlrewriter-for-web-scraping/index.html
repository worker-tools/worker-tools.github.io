<!DOCTYPE html>
<html lang="en"><head><title>How To Use HTMLRewriter for Web Scraping | Worker Tools</title><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="How To Use HTMLRewriter for Web Scraping" /><meta name="author" content="Florian Klampfer" /><meta property="og:locale" content="en" /><meta name="description" content="In this post we’ll be implementing a custom Hacker News API by scraping its HTML frontend, the same approach used by the unofficial HN API for Node." /><meta property="og:description" content="In this post we’ll be implementing a custom Hacker News API by scraping its HTML frontend, the same approach used by the unofficial HN API for Node." /><link rel="canonical" href="https://workers.tools/guides/2022-02-19-how-to-use-htmlrewriter-for-web-scraping/" /><meta property="og:url" content="https://workers.tools/guides/2022-02-19-how-to-use-htmlrewriter-for-web-scraping/" /><meta property="og:site_name" content="Worker Tools" /><meta property="og:image" content="https://workers.tools/assets/img/hn.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-19T00:00:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://workers.tools/assets/img/hn.jpeg" /><meta property="twitter:title" content="How To Use HTMLRewriter for Web Scraping" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Florian Klampfer"},"dateModified":"2022-06-08T06:29:45+00:00","datePublished":"2022-02-19T00:00:00+00:00","description":"In this post we’ll be implementing a custom Hacker News API by scraping its HTML frontend, the same approach used by the unofficial HN API for Node.","headline":"How To Use HTMLRewriter for Web Scraping","image":{"srcset":{"2560w":"/assets/img/hn.jpeg","1280w":"/assets/img/hn@0,5x.jpeg","640w":"/assets/img/hn@0,25x.jpeg"},"url":"https://workers.tools/assets/img/hn.jpeg","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://workers.tools/guides/2022-02-19-how-to-use-htmlrewriter-for-web-scraping/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://workers.tools/assets/img/logo_s.svg"},"name":"Florian Klampfer"},"url":"https://workers.tools/guides/2022-02-19-how-to-use-htmlrewriter-for-web-scraping/"}</script><meta name="theme-color" content="#ee9b33"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Worker Tools"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="application-name" content="Worker Tools"><meta name="generator" content="Hydejack v9.1.6-hysenberg.15" /><link rel="alternate" href="https://workers.tools/guides/2022-02-19-how-to-use-htmlrewriter-for-web-scraping/" hreflang="en"><link type="application/atom+xml" rel="alternate" href="https://workers.tools/feed.xml" title="Worker Tools" /><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/assets/img/logo.svg"><link rel="manifest" href="/assets/site.webmanifest"><link rel="preload" href="/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG"><link rel="dns-prefetch" href="/assets/js/search-worker-9.1.6-hysenberg.15.js" as="worker" id="_hrefSearch"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_katexPreload"> <noscript><link rel="stylesheet" href="/assets/bower_components/katex/dist/katex.min.css"></noscript> <script>!function(r,c){"use strict";function a(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=c.createElement("script"),e=(n.src=e,t&&a(n,"load",t,{once:!0}),c.scripts[0]);return e.parentNode.insertBefore(n,e),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=c.createElement("script");function o(){r._loaded=!0,t&&a(n,"load",t,{once:!0});var e=c.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():a(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){a(c.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); !function(w) { w._baseURL = '/'; w._publicPath = '/assets/js/'; w._noPushState = false; w._noDrawer = false; w._noNavbar = false; w._noToc = false; w._noSearch = true; w._advertise = false; w._search = { DATA_URL: '/assets/sitedata.json?no-cache', STORAGE_KEY: 'mini-search/', INDEX_KEY: 'index--2022-06-08T06:35:18+00:00', }; w._clapButton = false; }(window);</script> <!--[if gt IE 8]><!----><style id="_styleInline"> .clearfix,.sidebar-social::after{content:"";display:table;clear:both}.color-transition,.content .avatar,.landing-section,.nav-btn,.nav-btn-bar,.navbar,.message,.note-sm,#markdown-toc,.note,.hr-bottom,.hr-after::after,hr,.hr,p,body{transition:none}#_dark-mode{font-size:1.25rem}@media screen{body.light-mode{--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: #f6f6ef;--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg)}body.light-mode .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}body.dark-mode{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body.dark-mode .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}}@media screen and (prefers-color-scheme: dark){body{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.tippy-content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}}html{--font-family: system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,Arial,sans-serif;--font-family-heading: system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,Arial,sans-serif;--code-font-family: ui-monospace,Menlo,Monaco,Cascadia Mono,Segoe UI Mono,Roboto Mono,Oxygen Mono,Ubuntu Monospace,Source Code Pro,Fira Mono,Droid Sans Mono,Courier New,monospace;--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: #f6f6ef;--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg);--root-font-size: 15px;--root-font-size-medium: 16px;--root-font-size-large: 17px;--root-font-size-print: 8pt;--root-line-height: 1.75;--font-weight: 400;--font-weight-bold: 700;--font-weight-heading: 700;--content-width: 42rem;--content-width-2: 48rem;--content-width-5: 54rem;--content-margin-3: 3rem;--content-margin-5: 4rem;--sidebar-width: 21rem;--half-content: 31rem;--break-point-1: 42em;--break-point-2: 54em;--break-point-3: 64em;--break-point-4: 72em;--break-point-5: 86em;--break-point-font-large: 124em;--break-point-dynamic: 1664px}html .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}*{box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:var(--font-family);font-size:var(--root-font-size);line-height:var(--root-line-height)}body{color:var(--body-color);background-color:var(--body-bg);font-weight:var(--font-weight);overflow-y:scroll}.content img,.img,.content video,.video{max-width:100%;height:auto}.lead{margin-left:-1rem;margin-right:-1rem;margin-bottom:1.5rem}p.lead{margin-left:-1rem;margin-right:-1rem}img.lead,video.lead{max-width:calc(100% + 2rem)}img.land,video.land{margin-left:-1rem;margin-right:-1rem;width:calc(100% + 2rem);max-width:calc(100% + 12rem)}@media (min-width: 64em){img.land,video.land{margin-left:-6rem;margin-right:-6rem;width:calc(100% + 12rem)}}.heading,.f6,h6,.h6,.f5,h5,.h5,.f4,.sidebar-nav-item,h4,.h4,.post-date,.f3,h3,.h3,.f2,h2,.h2,.f1,h1,.h1{font-family:var(--font-family-heading);font-weight:var(--font-weight-heading)}.f1,h1,.h1{font-size:2rem;line-height:1.3}.f2,h2,.h2{font-size:1.5rem;line-height:1.4}.f3,h3,.h3{font-size:1.2em;line-height:1.5}.f4,.sidebar-nav-item,h4,.h4,.post-date{font-size:1.08rem;line-height:1.6}.f5,h5,.h5{font-size:1.04rem;line-height:1.7}.f6,h6,.h6{font-size:1rem}.content h1>a,.content .h1>a{text-decoration:none;border-bottom:none}@media screen and (min-width: 86em){.content h1,.content .h1{font-size:2.4rem;line-height:1.25}}@media screen and (min-width: 1664px){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{width:calc(100% + 50vw - 32rem);font-size:3rem;line-height:1.15}}@media screen and (min-width: 124em){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{font-size:4rem;line-height:1.1}}h1,h2,h3,.h1,.h2,.h3{margin:4rem 0 1rem}h4,h5,h6,.h4,.post-date,.h5,.h6{margin:3rem 0 .5rem}p{margin-top:0;margin-bottom:1rem}p.lead{font-size:1.2em;margin-top:1.5rem;margin-bottom:1.5rem;padding:0 1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}ul,ol{padding-left:1.25rem}hr,.hr{border:0;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-after::after{content:"";display:block;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-bottom{border-bottom:1px solid var(--border-color);padding-bottom:.75rem;margin-bottom:1rem}.page{position:relative;margin-bottom:3em}.page li+li{margin-top:.25rem}.page>header{position:relative;margin-bottom:2rem}.page .aspect-ratio.sixteen-nine.lead{margin-left:-1rem;margin-right:-1rem;width:calc(100% + 2rem)}@media (min-width: 64em){.page .aspect-ratio.sixteen-nine.lead{margin-left:-6rem;margin-right:-6rem;width:calc(100% + 12rem)}}.post{margin-bottom:6rem}@media screen and (min-width: 1664px){.post{margin-bottom:7rem}}@media screen and (min-width: 124em){.post{margin-bottom:8rem}}.page-title,.post-title{margin-top:0}.post-date{display:flex;justify-content:space-between;margin-top:-.6rem;height:2rem;margin-bottom:.85rem;color:var(--gray)}.post-date>.ellipsis,#breadcrumbs.post-date>ul{cursor:pointer}.post-date [class^="icon-"]{display:inline-block;font-size:smaller;margin-right:.25rem}body:not(.no-third-column) .page>.desc-note{transition:opacity 500ms ease, transform 500ms ease, border-color 1s ease}@media screen and (min-width: 1664px){body:not(.no-third-column) .page>.desc-note{position:absolute;z-index:4;top:6.5rem;bottom:0;width:16rem;left:-24rem}}@media screen and (min-width: 124em){body:not(.no-third-column) .page>.desc-note{width:21rem;left:-30rem}}body:not(.no-third-column) .page>.desc-note .dingbat{display:none}@media screen and (min-width: 1664px){body:not(.no-third-column) .page>.desc-note .dingbat{display:block}body:not(.no-third-column) .page>.desc-note .dingbat::after{text-align:left}}body:not(.no-third-column) .page>.desc-note clap-button{display:none}@media screen and (min-width: 1664px){body:not(.no-third-column) .page>.desc-note clap-button{display:block;width:3rem;height:3rem;margin:2rem 0;font-size:smaller}}body:not(.no-third-column) .page>.desc-note.desc-hide{opacity:0;transform:translateX(2rem)}body:not(.no-third-column) .page>.desc-note.desc-show{opacity:1;transform:translateX(0)}body:not(.no-third-column) .page>.desc-note .hidden{display:none}@media screen and (min-width: 1664px){body:not(.no-third-column) .page>.desc-note .hidden{display:block;opacity:0;transition:opacity 250ms ease, transform 350ms ease, color 1s ease, border-color 1s ease}}@media screen and (min-width: 1664px){body:not(.no-third-column) .page.with-img>.desc-note{top:25.5rem}}.related-posts{padding-left:0;list-style:none;margin-bottom:2rem}.related-posts>li,.related-posts>li+li{margin-top:1rem}.message,.note-sm,#markdown-toc,.note{margin-bottom:1rem;padding:1rem;color:var(--gray-text);background-color:var(--gray-bg);margin-left:-1rem;margin-right:-1rem}.note-sm,#markdown-toc,.note{background:transparent;color:var(--body-color);font-size:smaller;border-left:1px solid var(--border-color);padding:1.2rem 1rem 0 1rem;margin:1rem -1rem;position:relative}.note-sm:before,#markdown-toc:before,.note:before{font-size:0.667rem;font-weight:bold;font-style:normal;letter-spacing:.025rem;text-transform:uppercase;color:var(--menu-text);position:absolute;top:0}.note-sm[title]:before,#markdown-toc[title]:before,.note[title]:before{content:attr(title) !important}.note{font-size:1rem}@media screen and (min-width: 42em){html{font-size:var(--root-font-size-medium)}}@media screen and (min-width: 124em){html{font-size:var(--root-font-size-large)}}#breadcrumbs>ul{height:1rem;margin:-1.5rem 0 .5rem;padding:0;font-size:.667rem;color:var(--menu-text);text-transform:uppercase;width:100%;list-style:none}#breadcrumbs>ul>li{display:inline}#breadcrumbs>ul>li a{color:var(--gray);text-decoration:none;border-bottom:none}.fl{float:left}.fr{float:right}.mb0{margin-bottom:0}.mb2{margin-bottom:2rem}.mb4{margin-bottom:4rem}.mb6{margin-bottom:6rem}.mt0{margin-top:0}.mt1{margin-top:1rem}.mt2{margin-top:2rem}.mt3{margin-top:3rem}.mt4{margin-top:4rem}.mt6{margin-top:6rem}.pb0{padding-bottom:0}.ml1{margin-left:1rem}.mr1{margin-right:1rem}.sixteen-nine{position:relative}.sixteen-nine::before{display:block;content:"";width:100%;padding-top:56.25%}.sixteen-nine>*{position:absolute;top:0;left:0;right:0;bottom:0}.sixteen-ten{position:relative}.sixteen-ten::before{display:block;content:"";width:100%;padding-top:62.5%}.sixteen-ten>*{position:absolute;top:0;left:0;right:0;bottom:0}.four-three{position:relative}.four-three::before{display:block;content:"";width:100%;padding-top:75%}.four-three>*{position:absolute;top:0;left:0;right:0;bottom:0}.sr-only{display:none}.larger{font-size:larger}.smaller{font-size:smaller}.clearfix,.sidebar-social::after{content:"";display:table;clear:both}.ellipsis,#breadcrumbs>ul{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.border{border:1px solid var(--border-color)}@media (min-width: 42em){.border-radius,img.lead,video.lead,img.land,video.land,.page .aspect-ratio.sixteen-nine.lead{border-radius:.5rem}}.fallback-img{background-position:center;background-repeat:no-repeat;background-image:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxnIHRyYW5zZm9ybT0ibWF0cml4KDAuMDQ4ODI4LCAwLCAwLCAwLjA0Nzk5MSwgNTQuOTk5OTczLCAyMC40MjgxNDgpIj4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTk1OS44ODQgMTI4YzAuMDQwIDAuMDM0IDAuMDgyIDAuMDc2IDAuMTE2IDAuMTE2djc2Ny43N2MtMC4wMzQgMC4wNDAtMC4wNzYgMC4wODItMC4xMTYgMC4xMTZoLTg5NS43N2MtMC4wNDAtMC4wMzQtMC4wODItMC4wNzYtMC4xMTQtMC4xMTZ2LTc2Ny43NzJjMC4wMzQtMC4wNDAgMC4wNzYtMC4wODIgMC4xMTQtMC4xMTRoODk1Ljc3ek05NjAgNjRoLTg5NmMtMzUuMiAwLTY0IDI4LjgtNjQgNjR2NzY4YzAgMzUuMiAyOC44IDY0IDY0IDY0aDg5NmMzNS4yIDAgNjQtMjguOCA2NC02NHYtNzY4YzAtMzUuMi0yOC44LTY0LTY0LTY0djB6Ii8+CiAgICA8cGF0aCBzdHlsZT0iZmlsbDpyZ2JhKDEyOCwxMjgsMTI4LC4zMykiIGQ9Ik04MzIgMjg4YzAgNTMuMDIwLTQyLjk4IDk2LTk2IDk2cy05Ni00Mi45OC05Ni05NiA0Mi45OC05NiA5Ni05NiA5NiA0Mi45OCA5NiA5NnoiLz4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTg5NiA4MzJoLTc2OHYtMTI4bDIyNC0zODQgMjU2IDMyMGg2NGwyMjQtMTkyeiIvPgogIDwvZz4KPC9zdmc+")}hy-push-state a{color:var(--body-color)}@supports not ((text-decoration-thickness: initial) and (text-underline-offset: initial)){hy-push-state a{text-decoration:none;border-bottom:2px solid}}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){hy-push-state a{text-decoration-style:solid;text-underline-offset:.35rem;text-decoration-thickness:2px}}hy-push-state a.no-hover{border-bottom:none;text-decoration-thickness:unset;text-underline-offset:unset}.content a:not(.btn):not(.no-hover){border-color:var(--accent-color-faded)}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){.content a:not(.btn):not(.no-hover){text-decoration-color:var(--accent-color-faded)}}.content .aspect-ratio{overflow:hidden}.content .aspect-ratio img{margin:0;width:100%;height:100%;background-color:var(--gray-bg)}hy-drawer{width:100%;position:relative;overflow:hidden;display:block;z-index:4}@media screen and (min-width: 1664px){hy-drawer{width:calc(50% - 31rem)}}.sidebar{position:relative;display:flex;justify-content:center;align-items:center;color:rgba(255,255,255,0.75);text-align:center;min-height:100vh}.sidebar.invert{color:rgba(32,32,32,0.75)}.sidebar a{color:#fff;border-bottom-color:rgba(255,255,255,0.2);text-decoration-color:rgba(255,255,255,0.2)}.sidebar.invert a{color:#222;border-bottom-color:rgba(32,32,32,0.2);text-decoration-color:rgba(32,32,32,0.2)}.sidebar-bg{position:absolute;top:0;left:calc(50% - 50vw);width:100vw;height:100%;background:#202020 center / cover}.sidebar-bg::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,0.05)}.sidebar-bg.sidebar-overlay::after{background:linear-gradient(to bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 50%, rgba(32,32,32,0) 100%)}.sidebar-sticky{position:relative;z-index:3;max-width:21rem;padding:1.5rem;contain:content}.sidebar-about .avatar{margin-bottom:1.5rem}.sidebar-about>a.sidebar-title{text-decoration:none}.sidebar-about>a.sidebar-title>h2{margin:0;padding-bottom:.5rem}.sidebar-about>a.sidebar-title::after{content:'';display:block;border-bottom:2px solid;margin:0 auto .5rem;width:4rem;border-color:rgba(255,255,255,0.2);transition:border-color 250ms}.sidebar-about>a.sidebar-title:hover::after{border-color:#fff;transition:border-color 50ms}.sidebar.invert .sidebar-about>a.sidebar-title::after{border-color:rgba(32,32,32,0.2)}.sidebar.invert .sidebar-about>a.sidebar-title:hover::after{border-color:#222}.sidebar-nav>ul{list-style:none;padding-left:0}.sidebar-nav-item{display:inline-block;margin-bottom:.5rem}@media (min-width: 64em){#_main.no-drawer #_menu{display:none}#_main.no-drawer .nav-btn-bar>:nth-child(2){border:none}}.sidebar-social>ul{display:inline-block;list-style:none;padding-left:0;margin-bottom:0}.sidebar-social>ul>li{float:left}.sidebar-social>ul>li>a{display:inline-block;text-align:center;font-size:1.4rem;width:3rem;height:4rem;padding:.5rem 0;line-height:3rem;text-decoration:none;border-bottom-width:2px;border-bottom-style:solid}.sidebar-social>ul li+li{margin-top:0}.fixed-common,.fixed-bottom,.fixed-top{position:fixed;left:0;width:100%;z-index:2}.fixed-top{top:0}.fixed-bottom{bottom:0}.navbar>.content{position:relative;padding-top:0;padding-bottom:0;min-height:0;max-height:5rem}.nav-btn-bar{margin:0 -1rem;background-color:white;background-color:var(--body-bg);height:5rem;display:flex;align-items:center;position:relative}.nav-btn-bar>:first-child,.nav-btn-bar>:last-child{border:none}.nav-btn{background:none;border:none;text-decoration:none;display:flex;align-items:center;justify-content:center;width:3.25rem;height:5rem;color:var(--menu-text);border-right:1px solid var(--border-color);border-left:1px solid var(--border-color);margin-left:-1px}#markdown-toc{margin:1rem -1rem 1rem calc(-1rem + 1px);padding-left:2.5rem;padding-bottom:.5rem}#markdown-toc:before{left:1rem}@media screen and (min-width: 1664px){body:not(.no-toc) #toc-wrapper{position:absolute;z-index:4;top:10rem;bottom:0;width:18.5rem;right:calc(-1 * (50vw - 27.5rem))}body:not(.no-toc) .with-img #toc-wrapper{top:46rem}body:not(.no-toc) #markdown-toc{overflow-y:auto;max-height:calc(100vh - 1rem)}}@media screen and (min-width: 1664px){body.no-break-layout:not(.no-toc) #toc-wrapper{width:calc(50vw - 36rem)}}.content{margin-left:auto;margin-right:auto;padding:8rem 1rem 12rem}@media screen{.content{padding-left:1.5rem;min-height:100vh;margin:auto}}@media screen and (min-width: 42em){.content{max-width:42rem}}@media screen and (min-width: 54em){.content{max-width:48rem}}@media screen and (min-width: 86em){.content{padding-top:9rem;max-width:54rem}}.large-only{display:none}@media screen and (min-width: 1664px){.large-only{display:block}}.landing-section{background:var(--gray-bg);--mar: -1rem;margin:3rem var(--mar);padding:1rem calc(-1 * var(--mar))}@media screen and (min-width: 42em){.landing-section{--mar: calc(-50vw + 20rem)}}@media screen and (min-width: 54em){.landing-section{--mar: calc(-50vw + 23rem)}}@media screen and (min-width: 86em){.landing-section{--mar: calc(-50vw + 26rem)}}.layout-landing #breadcrumbs,.layout-home #breadcrumbs{display:none}.layout-landing>.page>header,.layout-home>.page>header{position:relative;border-top:1px solid var(--border-color);border-bottom:1px solid var(--border-color);margin-top:-8rem;padding:10rem 1rem 2rem 1rem;display:flex;align-items:center;justify-content:center}.layout-landing>.page>header.opened,.layout-home>.page>header.opened{height:100vh;border:none}@media screen and (min-width: 86em){.layout-landing>.page>header,.layout-home>.page>header{margin-top:-9rem}}.layout-landing>.page>header>.landing-sticky,.layout-home>.page>header>.landing-sticky{position:relative;z-index:2}.layout-landing>.page>header>.landing-sticky>h1.app-title,.layout-home>.page>header>.landing-sticky>h1.app-title{width:100%;text-align:center;font-size:4rem;margin-top:4rem}@media screen and (max-width: 42em){.layout-landing>.page>header>.landing-sticky>h1.app-title,.layout-home>.page>header>.landing-sticky>h1.app-title{font-size:2.5rem}}.layout-landing>.page>header>.landing-sticky>.app-lead,.layout-home>.page>header>.landing-sticky>.app-lead{max-width:640px;margin-left:auto !important;margin-right:auto !important}.layout-landing>.page>header>.landing-sticky>.app-button,.layout-home>.page>header>.landing-sticky>.app-button{display:block;text-align:center;height:9rem;width:9rem;margin:2rem auto 4rem auto}.landing-bg{position:absolute;top:0;left:0;right:0;bottom:0;background:#202020 center / cover}.landing-bg::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,0.05)}.avatar{width:7rem;height:7rem;border-radius:100%;overflow:hidden;display:inline-block}.avatar img{width:100%}.content .avatar{float:right;box-sizing:content-box;border:1rem solid var(--body-bg);transition:border-color 1s ease;margin-top:-1.5rem;margin-right:-1rem}html{--dark-mode-body-bg: hsl(227, 10%, 12%)!important;--dark-mode-border-color: hsl(227, 10%, 24%)!important}@media (prefers-color-scheme: dark){.sidebar{filter:brightness(0.75)}}.dark-mode .sidebar{filter:brightness(0.75)}.light-mode .sidebar{filter:none}.note:before{content:"Note"}.page>header>.note-sm:before,.page>header>.note:before,.page>header>#markdown-toc:before,.page>.desc-note .note-sm:before,.page>.desc-note .note:before,.page>.desc-note #markdown-toc:before{content:"Description"}#markdown-toc:before{content:"Table of Contents"}.layout-resume .note-sm:before,.layout-resume .note:before,.layout-resume #markdown-toc:before{content:"Summary"} .clearfix,main:not(.layout-resume) .columns::after{content:"";display:table;clear:both}.color-transition,main:not(.layout-resume) .project-card{transition:none}main:not(.layout-resume) .columns{display:flex;flex-wrap:wrap;contain:content;margin-top:1rem;margin-left:-1.5rem;margin-right:-1rem;padding-top:1rem;padding-right:1rem}main:not(.layout-resume) .column{float:left;padding-left:1.5rem;margin-bottom:2rem;width:100%;display:flex}@media screen and (min-width: 42em){main:not(.layout-resume) .columns{margin-left:-2.5rem;margin-right:-2rem}main:not(.layout-resume) .column-1-2{width:50%}}@media screen and (min-width: 64em){main:not(.layout-resume) .columns{margin-left:-7.5rem;margin-right:-7rem}main:not(.layout-resume) .column-1-2{width:50%}}@media print{main:not(.layout-resume) .columns{display:block}main:not(.layout-resume) .column{display:block;width:50%}}main:not(.layout-resume) .project-card{width:100%;color:var(--gray-text);background-color:var(--gray-bg);padding-bottom:1rem;position:relative;overflow:hidden;box-shadow:0.125rem 0.125rem 1rem rgba(0,0,0,0.2);contain:content;border-radius:.5rem;page-break-inside:avoid;transition:transform 500ms ease;will-change:transform}main:not(.layout-resume) .project-card:hover{transform:translateY(-0.25rem);transition:transform 250ms ease}main:not(.layout-resume) .project-card>a.flip-project{display:block}main:not(.layout-resume) .project-card>a.flip-project .project-card-img{margin-bottom:0}main:not(.layout-resume) .project-card>a.flip-project .project-card-img img{display:block;border-top-left-radius:.5rem;border-top-right-radius:.5rem}main:not(.layout-resume) .project-card a{position:relative;z-index:1}main:not(.layout-resume) .project-card a.fill-card{position:absolute;top:0;left:0;right:0;bottom:0;z-index:0}main:not(.layout-resume) .project-card>.project-card-title,main:not(.layout-resume) .project-card>.project-card-text{text-align:center;padding:0 1rem}main:not(.layout-resume) .project-card>.project-card-title{display:block;font-size:1.08rem;margin-top:.75rem;margin-bottom:.25rem;color:inherit}main:not(.layout-resume) .project-card>.project-card-text{margin:.25rem 0}main:not(.layout-resume) .column-1>.project-card>.project-card-title{font-size:1.2rem}main:not(.layout-resume) .column-1>.project-card>.project-card-text{font-size:1rem}</style><link rel="preload" as="style" href="/assets/css/hydejack-9.1.6-hysenberg.15.css" id="_stylePreload"><link rel="preload" as="style" href="/assets/icomoon/style.css" id="_iconsPreload"> <script> setRel('_stylePreload'); setRel('_iconsPreload'); /**/ </script> <noscript><link rel="stylesheet" href="/assets/css/hydejack-9.1.6-hysenberg.15.css"><link rel="stylesheet" href="/assets/icomoon/style.css"> </noscript><style id="_pageStyle"> html{--accent-color: rgb(243,128,32);--accent-color-faded: rgba(243,128,32,0.5);--accent-color-highlight: rgba(243,128,32,0.1);--accent-color-darkened: #e16d0c;--theme-color: #ee9b33;--dark-mode-body-bg: #312d28;--dark-mode-border-color: #3f3a33}</style><!--<![endif]--> <script defer data-domain="workers.tools" src="https://plausible.io/js/plausible.js"></script><body class=""> <script> window._sunrise = 6; window._sunset = 18; !function(e,s){var d="light-mode",o="dark-mode",a=(new Date).getHours();"matchMedia"in e&&e.matchMedia("(prefers-color-scheme)")||(e=(a=a<=e._sunrise||a>=e._sunset?o:d)==o?d:o,s.body.classList.add(a),s.body.classList.remove(e))}(window,document); </script> <hy-push-state id="_pushState" replace-selector="#_main" link-selector="a[href]:not([href^='/assets/']):not(.external):not(.no-push-state)" script-selector="script" duration="500" hashchange ><div id="_navbar" class="navbar fixed-top"><div class="content"> <span class="sr-only">Jump to:</span><div class="nav-btn-bar"> <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a><div class="nav-span"></div></div></div></div><hr class="sr-only" hidden /><main id="_main" class="content layout-post" role="main" ><nav id="breadcrumbs" class="screen-only"><ul><li><a href="/">worker-tools</a><li> <span>/</span> <a href="/guides/">guides</a><li> <span>/</span> <span>2022-02-19-how-to-use-htmlrewriter-for-web-scraping</span></ul></nav><article id="post-guides-how-to-use-htmlrewriter-for-web-scraping" class="page post with-img" role="article"><header><h1 id="how-to-use-htmlrewriter-for-web-scraping" class="post-title flip-project-title"> How To Use HTMLRewriter for Web Scraping</h1><div class="post-date"> <span class="ellipsis mr1"> <time datetime="2022-02-19T00:00:00+00:00">19 Feb 2022</time> in <a href="/guides/" class="flip-title">Guides</a> </span> <span class="ellipsis" data-tippy-content="Last modified at: 08 Jun 2022"> <span class="sr-only">Last modified at:</span> <span class="icon-history"></span> <time datetime="2022-06-08T06:29:45+00:00">2022-06-08</time> </span></div><div class="img-wrapper lead aspect-ratio sixteen-nine flip-project-img"> <img src="/assets/img/hn.jpeg" srcset="/assets/img/hn.jpeg 2560w,/assets/img/hn@0,5x.jpeg 1280w,/assets/img/hn@0,25x.jpeg 640w" alt="How To Use HTMLRewriter for Web Scraping" width="864" height="486" loading="lazy" /></div></header><div class="desc-note"><div style="position:sticky; top: 10rem;"><div class="hidden f3">How To Use HTMLRewriter for Web Scraping</div><div class="hidden heading smaller faded"><time datetime="2022-02-19T00:00:00+00:00">19 Feb 2022</time> in <a href="/guides/" class="flip-title">Guides</a></div><p class="note-sm" > In this post we’ll be implementing a custom Hacker News API by scraping its HTML frontend, the same approach used by the unofficial HN API for Node.<hr class="dingbat related mb6" /></div></div><p>Cloudflare Workers comes with a streaming HTML rewriting tool programmatically called HTMLRewriter. Unlike HTML parses like <a href="https://github.com/jsdom/jsdom">jsdom</a> or <a href="https://github.com/WebReflection/linkedom">linkedom</a>, it works at a fraction of their CPU and memory cost since it will simply “pass through” any elements that aren’t explicitly requested. This makes it also interesting for efficiently scraping web content in Cloudflare Workers.<p class="note faded"><em>Web scraping is getting increasingly difficult, ironically not least due to Cloudflare’s own Scrape Shield, which deploys various techniques such as TLS fingerprinting to determine who is accessing a site. CF Workers doesn’t hide the fact that it is not a User Agent (i.e. browser). It is only suitable for light scraping uses. Of course the same applies to any HTMLRewriter use case.</em><p>In this post we’ll be implementing a custom Hacker News API by scraping its HTML frontend, the same approach used by the <a href="https://github.com/cheeaun/node-hnapi">unofficial HN API for Node</a>. The examples are taken from <a href="../../_projects/worker-news.md" class="flip-title heading">Worker News</a>.<h2 id="introduction">Introduction</h2><p>At first glace, HTMLRewriter is a poor fit for HTML scraping. It’s API is geared towards rewriting a HTML response, not extracting data from it. To familiarize ourselves with the API, here is a slightly modified example from Cloudflare’s <a href="https://developers.cloudflare.com/workers/tutorials/localize-a-website">tutorial</a>:<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">fetch</span><span class="dl">'</span><span class="p">,</span> <span class="nx">ev</span> <span class="o">=&gt;</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">handleEvent</span><span class="p">(</span><span class="nx">ev</span><span class="p">)))</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">handleEvent</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getAssetFromKV</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">HTMLRewriter</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">[data-i18n-key]</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">element</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// &lt;-- Everything callback-based</span>
        <span class="kd">const</span> <span class="nx">i18nKey</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">data-i18n-key</span><span class="dl">"</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">strings</span><span class="p">[</span><span class="nx">i18nKey</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="nx">el</span><span class="p">.</span><span class="nx">setInnerContent</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
      <span class="p">},</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="c1">// &lt;-- Returns a `Response`</span>
<span class="p">}</span>
</code></pre></div></div><p>First, we note that everything in HTMLRewriter is callback-based. Second, we note its transform API: It expects to turn one <code class="language-plaintext highlighter-rouge">Response</code> into another. When web scraping, we just want to <em>consume</em> a response but not process it in any further or send it to the client.<p>Besides these ergonomic inconveniences, its biggest drawback is its lack of “inner HTML” API. HTML Rewriter can notify us of element tags or text chunks, but it can’t give us the contents of an entire subtree in the DOM. There is hope that this will be implemented in the future, but for now we’ve have to work around this. The recently added (still undocumented) <code class="language-plaintext highlighter-rouge">onEndTag</code> feature finally gives us the tool to make this possible.<ul id="markdown-toc"><li><a href="#introduction" id="markdown-toc-introduction">Introduction</a><li><a href="#consuming-a-response" id="markdown-toc-consuming-a-response">Consuming a Response</a><ul><li><a href="#streaming-consume" id="markdown-toc-streaming-consume">Streaming Consume</a></ul><li><a href="#extracting-data" id="markdown-toc-extracting-data">Extracting Data</a><ul><li><a href="#extracting-data-streams" id="markdown-toc-extracting-data-streams">Extracting Data Streams</a></ul><li><a href="#extracting-html-subtrees" id="markdown-toc-extracting-html-subtrees">Extracting HTML Subtrees</a><li><a href="#appendix" id="markdown-toc-appendix">Appendix</a><ul><li><a href="#custom-event-polyfill" id="markdown-toc-custom-event-polyfill">Custom Event Polyfill</a></ul></ul><h2 id="consuming-a-response">Consuming a Response</h2><p>We first work around the <code class="language-plaintext highlighter-rouge">transform</code> issue. What makes the example above work is the fact that the <code class="language-plaintext highlighter-rouge">Response</code> provided by <code class="language-plaintext highlighter-rouge">transform</code> is passed to <code class="language-plaintext highlighter-rouge">respondWith</code> in the fetch event. This causes data to be <em>pulled</em> from the stream as it makes its way towards the (browser) client, which sets the whole streaming pipeline in motion.<p>Since we won’t be sending the craping response to the client, we need a different way to pull data from the stream. A quick and dirty solution is to just await <code class="language-plaintext highlighter-rouge">.text()</code> on the transformed response. But this causes the entire response body to be loaded into a string:<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://news.ycombinator.com</span><span class="dl">'</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Scrape shield encountered!</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">rewriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HTMLRewriter</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">.athing[id]</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* TODO */</span> <span class="p">}</span>
  <span class="p">});</span>

<span class="kd">const</span> <span class="nx">_text</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">rewriter</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">response</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>
</code></pre></div></div><p>While this works, it’s still not ideal since it will force the entire document into memory at one point, only to be discarded right afterwards.<h3 id="streaming-consume">Streaming Consume</h3><p>A better solution is to consume the response stream chunk by chunk:<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">consume</span><span class="p">(</span><span class="nx">stream</span><span class="p">:</span> <span class="nx">ReadableStream</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">reader</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">getReader</span><span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">await</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">read</span><span class="p">()).</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* NOOP */</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">await</span> <span class="nx">consume</span><span class="p">(</span><span class="nx">rewriter</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">response</span><span class="p">).</span><span class="nx">body</span><span class="o">!</span><span class="p">);</span>
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">consume</code> helper function, as the name suggests, pulls every chunk from the stream and discards it. By accepting a readable stream we keep it generic enough to accept other types of readable streams as well. In the case of a Fetch API <code class="language-plaintext highlighter-rouge">Response</code>, we access its stream via the <code class="language-plaintext highlighter-rouge">.body</code> property.<h2 id="extracting-data">Extracting Data</h2><p>With the transform pipeline set in motion, we can focus turn our attention to the callbacks. Once again, we start with a quick and dirty solution (that may very well be good enough for your use case) and then improve it later.<p>In the code below we extract the Hacker News item id from every post on the landing page:<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">ids</span> <span class="o">=</span> <span class="p">[]</span>
<span class="kd">const</span> <span class="nx">rewriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HTMLRewriter</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">.athing[id]</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ids</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>

<span class="k">await</span> <span class="nx">consume</span><span class="p">(</span><span class="nx">rewriter</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">response</span><span class="p">).</span><span class="nx">body</span><span class="o">!</span><span class="p">)</span>

<span class="c1">// `ids` is now populated:</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ids</span><span class="p">)</span>
</code></pre></div></div><p>We use good old <em>imperative programming and async/await</em> to populate our <code class="language-plaintext highlighter-rouge">ids</code> array. As I said earlier, this may very well be good enough for you, but it does have the drawback of consuming the entire response before we continue processing the ids. In other words, we lose the streaming aspect of HTMLRewriter.<h3 id="extracting-data-streams">Extracting Data Streams</h3><p>A more fancy approach is to turn the callbacks into an async iterable that we process as data arrives in a <code class="language-plaintext highlighter-rouge">for await</code> loop. For a refresher on asynchronous data processing in JavaScript, see my own <a href="https://qwtel.com/posts/software/async-generators-in-the-wild/" class="heading">Async Generators in the Wild</a>.<p>Turning a (multi-)callback API into an async iterable is not trivial. It involves two steps:<ol><li>First we turn callback invocations into events,<li>then we use a utility function to turn the event stream into an async iterable.</ol><p>The utility function is provided by yours truly as <a href="https://www.npmjs.com/package/event-target-to-async-iter"><code class="language-plaintext highlighter-rouge">event-target-to-async-iter</code></a>, but the code is simply an adaptation of Node’s <a href="https://github.com/nodejs/node/blob/5b59e14dafb43b907e711cb418bb9c302bce2890/lib/events.js#L1017"><code class="language-plaintext highlighter-rouge">on</code></a> utility function with the Node-specific parts removed.<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventTarget</span><span class="p">();</span> <span class="c1">// 1</span>

<span class="kd">const</span> <span class="nx">rewriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HTMLRewriter</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">.athing[id]</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">target</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="k">new</span> <span class="nx">CustomEvent</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>  <span class="c1">// 2</span>
        <span class="na">detail</span><span class="p">:</span> <span class="nx">el</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">)</span> 
      <span class="p">}));</span>
    <span class="p">}</span>
  <span class="p">})</span>

<span class="kd">const</span> <span class="nx">iter</span> <span class="o">=</span> <span class="nx">evenTargetToAsyncIter</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// 3</span>

<span class="nx">consume</span><span class="p">(</span><span class="nx">rewriter</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">response</span><span class="p">).</span><span class="nx">body</span><span class="o">!</span><span class="p">)</span> <span class="c1">// 4</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="nx">iter</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="c1">// 5</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">iter</span><span class="p">.</span><span class="k">return</span><span class="p">())</span> <span class="c1">// 6</span>

<span class="k">for</span> <span class="k">await</span> <span class="p">(</span><span class="kd">const</span> <span class="p">{</span> <span class="na">detail</span><span class="p">:</span> <span class="nx">id</span> <span class="p">}</span> <span class="k">of</span> <span class="nx">iter</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 7</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div><p>There is a lot to unpack here. First of all, any experienced developer will undoubtedly spot the many of ways of making this more ergonomic, but for our purposes here I left it as verbose as is.<p>The goal is to process scraped data in (7) via <code class="language-plaintext highlighter-rouge">for await</code> loop. This leaves us with many opportunities down the line, such as streaming JSON for APIs, streaming HTML, Server Sent Events, etc…<p>While it is possible to dispatch events on the global scope (which implements <code class="language-plaintext highlighter-rouge">EventTarget</code>), it is advisable to use a new <code class="language-plaintext highlighter-rouge">EventTarget</code> as in (1) instead. Recent compatibility dates of CF Workers support this out of the box.<p>Unfortunately the same can’t be said for <code class="language-plaintext highlighter-rouge">CustomEvent</code> (2), but a <a href="#custom-event-polyfill">minimal polyfill</a> is trivially implemented. Custom Events are good use here, as the provide a generic <code class="language-plaintext highlighter-rouge">detail</code> property that we can use to store data. We fire them under the generic <code class="language-plaintext highlighter-rouge">data</code> event name. You can pick anything here, it only needs to match the key used in (3).<p>In (3) we turn the event target into an async iterable. Note that this only sets up queues and event listeners, but does not do anything by itself.<p>The process only starts once we start pulling data in (4). What’s important is that <strong>we do not <code class="language-plaintext highlighter-rouge">await</code> here</strong>! Doing so would defeat the purpose of setting up the streaming pipeline, as we wait for the entire response to be consumed (filling up the internal queues of <code class="language-plaintext highlighter-rouge">eventTargetToAsyncIter</code>) before continuing the execution.<p>Not awaiting a promise opens us up to the possibility of an unhandled exception, so we need catch it in (5) and forward it to the async iterable via <code class="language-plaintext highlighter-rouge">throw()</code>. This will cause the error to show up in (7) during for await looping.<p>Finally, in (6) we prevent for-await from getting stuck in an endless loop. Event targets, unlike async iterables, do not have a concept of an end, so we manually call <code class="language-plaintext highlighter-rouge">return()</code> on the iterable when the response stream is fully consumed.<h2 id="extracting-html-subtrees">Extracting HTML Subtrees</h2><p>We make up for HTMLRewriter’s lack of <code class="language-plaintext highlighter-rouge">innerHTML</code> by combining two selectors and use of the recently added <code class="language-plaintext highlighter-rouge">onEndTag</code> API:<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">commText</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">rewriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HTMLRewriter</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">.fatitem .commtext</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="c1">// 1</span>
    <span class="nx">text</span><span class="p">({</span> <span class="nx">text</span> <span class="p">})</span> <span class="p">{</span> <span class="nx">commText</span> <span class="o">+=</span> <span class="nx">text</span> <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">.fatitem .commtext *</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="c1">// 2</span>
    <span class="nx">element</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span> 
      <span class="kd">const</span> <span class="nx">maybeAttrs</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">el</span><span class="p">.</span><span class="nx">attributes</span><span class="p">].</span><span class="nx">map</span><span class="p">(([</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="s2">` </span><span class="p">${</span><span class="nx">k</span><span class="p">}</span><span class="s2">="</span><span class="p">${</span><span class="nx">v</span><span class="p">}</span><span class="s2">"`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
      <span class="nx">commText</span> <span class="o">+=</span> <span class="s2">`&lt;</span><span class="p">${</span><span class="nx">el</span><span class="p">.</span><span class="nx">tagName</span><span class="p">}${</span><span class="nx">maybeAttrs</span><span class="p">}</span><span class="s2">&gt;`</span><span class="p">;</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">onEndTag</span><span class="p">(</span><span class="nx">endTag</span> <span class="o">=&gt;</span> <span class="p">{</span> 
        <span class="nx">commText</span> <span class="o">+=</span> <span class="s2">`&lt;/</span><span class="p">${</span><span class="nx">endTag</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">&gt;`</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">})</span>
</code></pre></div></div><p>If we only used the first selector and applied it to, e.g. <a href="https://news.ycombinator.com/item?id=26631078">this comment</a> we would get the following:<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>There's lots of things going on this this space. It seems every other day I discover another 
Cloudflare Workers-like implementation (granted, most of them are for testing/development). 
I'm cataloging them here for anyone who's interested: https://workers.js.org
</code></pre></div></div><p>This seems correct at first, but it is missing the <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> tag on the link. This works because the <code class="language-plaintext highlighter-rouge">text</code> callback delivers every text chunk in the entire subtree. It does however ignore all the tags.<p>Once we add the second selector with the extra <code class="language-plaintext highlighter-rouge">*</code>, we are notified of <em>all</em> opening and closing tags <em>in the entire subtree</em> and can append them to the string. Because HTMLRewriter is a stream processor internally, we can expect these callbacks to be called in the correct order.<p><br /><h2 id="appendix">Appendix</h2><h3 id="custom-event-polyfill">Custom Event Polyfill</h3><p>Note that this is by no means a spec-compliant implementation of CustomEvent, but it works for our purpose here.<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="dl">'</span><span class="s1">CustomEvent</span><span class="dl">'</span> <span class="k">in</span> <span class="nb">self</span><span class="p">))</span> <span class="p">{</span>
  <span class="kd">class</span> <span class="nx">CustomEvent</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nx">Event</span> <span class="p">{</span>
    <span class="k">readonly</span> <span class="nx">detail</span><span class="p">:</span> <span class="nx">T</span><span class="p">;</span> 
    <span class="kd">constructor</span><span class="p">(</span><span class="nx">event</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="p">{</span> <span class="nx">detail</span> <span class="p">}:</span> <span class="nx">CustomEventInit</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span> 
      <span class="k">super</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span> 
      <span class="k">this</span><span class="p">.</span><span class="nx">detail</span> <span class="o">=</span> <span class="nx">detail</span> <span class="k">as</span> <span class="nx">T</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="dl">'</span><span class="s1">CustomEvent</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">configurable</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">enumerable</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">writable</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">value</span><span class="p">:</span> <span class="nx">CustomEvent</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div><hr class="dingbat related mb6" /></article><footer class="content" role="contentinfo"><hr/><p><small class="copyright">© 2022 Florian Klampfer <a href="https://qwtel.com/">qwtel.com</a> </small><hr class="sr-only"/></footer></main><hy-drawer id="_drawer" class="" side="left" threshold="10" noscroll ><header id="_sidebar" class="sidebar invert" role="banner"><div class="sidebar-bg " style="background:linear-gradient(to bottom, #e9bc4b, #f38020)"></div><div class="sidebar-sticky"><div class="sidebar-about"> <a class="no-hover" href="/" tabindex="-1"> <img src="/assets/img/logo_s.svg" class="avatar" alt="Worker Tools" width="120" height="120" loading="lazy" /> </a> <a class="sidebar-title" href="/"><h2 class="h1">Worker Tools</h2></a><p class=""> Tools for writing HTTP servers</div><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <a id="_drawer--opened" href="/examples/" class="sidebar-nav-item " > Examples </a><li> <a href="/guides/" class="sidebar-nav-item " > Guides </a></ul></nav><div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://github.com/worker-tools" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a><li> <a href="https://www.npmjs.com/org/worker-tools" title="npm" class="no-mark-external"> <span class="icon-npm"></span> <span class="sr-only">npm</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <!--[if gt IE 10]><!----> <script nomodule>!function(){var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())}(); </script> <script src="/assets/js/hydejack-9.1.6-hysenberg.15.js" type="module"></script> <script src="/assets/js/LEGACY-hydejack-9.1.6-hysenberg.15.js" nomodule defer></script> <script type="module"> if ('serviceWorker' in navigator) { /**/ navigator.serviceWorker.getRegistration() .then(r => r.unregister()) .catch(() => {}); /**/ } </script> <!--<![endif]--><div hidden><h2 class="sr-only">Templates (for web app):</h2><template id="_animation-template"><div class="animation-main fixed-top"><nav id="breadcrumbs" class="screen-only"><ul></ul></nav><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template"><div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span></div></template> <template id="_error-template"><div class="page"><h1 class="page-title">Error</h1><p class="lead"> Sorry, an error occurred while loading <a class="this-link" href=""></a>.</div></template> <template id="_permalink-template"> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="content-hash"></span> </a> </template> <template id="_dark-mode-template"> <button id="_dark-mode" class="nav-btn no-hover" > <span class="sr-only">Dark Mode</span> <span class="icon-brightness-contrast"></span> </button> </template></div></html>
